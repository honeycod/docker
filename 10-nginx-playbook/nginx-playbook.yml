---
- name: –ó–∞–ø—É—Å–∫ Nginx –≤ Docker —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º index.html –∏ –∫–æ–Ω—Ñ–∏–≥–æ–º
  hosts: demo
  become: yes
  vars:
    nginx_conf_dir: "/opt/nginx/conf"
    nginx_html_dir: "/opt/nginx/html"
    nginx_conf_file: "{{ nginx_conf_dir }}/nginx.conf"
    nginx_html_file: "{{ nginx_html_dir }}/index.html"
    container_name: my_nginx

  tasks:
    - name: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–∞ –∏ HTML —Å—É—â–µ—Å—Ç–≤—É—é—Ç
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ nginx_conf_dir }}"
        - "{{ nginx_html_dir }}"

    - name: –°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π index.html
      copy:
        content: |
          <!DOCTYPE html>
          <html >
          <head>
              <meta charset="UTF-8">
              <title>My Nginx</title>
          </head>
          <body>
              <h1>üéâ Nginx –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ Docker —Å Ansible!</h1>
              <p>–≠—Ç–æ—Ç —Ñ–∞–π–ª –ø–æ–¥–∫–ª—é—á—ë–Ω —á–µ—Ä–µ–∑ volume.</p>
          </body>
          </html>
        dest: "{{ nginx_html_file }}"
        mode: '0644'

    - name: –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª nginx.conf
      copy:
        content: |
          server {
              listen 80;
              root /usr/share/nginx/html;

              location / {
                  index index.html index.htm;
                  try_files $uri $uri/ /index.html =404;
              }

              error_page 404 /index.html;
              location = /404 {
                  return 404;
              }
          }
        dest: "{{ nginx_conf_file }}"
        mode: '0644'

    - name: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Docker —Å–ª—É–∂–±–∞ –∑–∞–ø—É—â–µ–Ω–∞
      service:
        name: docker
        state: started
        enabled: yes

    - name: –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Nginx —Å –ø—Ä–æ–±—Ä–æ—Å–æ–º –ø–æ—Ä—Ç–æ–≤ –∏ volumes
      docker_container:
        name: "{{ container_name }}"
        image: nginx:alpine
        ports:
          - "8081:80"
        volumes:
          - "{{ nginx_html_file }}:/usr/share/nginx/html/index.html"
          - "{{ nginx_conf_file }}:/etc/nginx/conf.d/default.conf"
        restart_policy: always
        state: started

    - name: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
      command: docker ps --filter "name={{ container_name }}" --filter "status=running" --quiet
      register: container_check
      changed_when: false

    - name: –í—ã–≤–µ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      debug:
        msg: |
          –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä Nginx —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!
          –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:8081
      when: container_check.stdout != ""